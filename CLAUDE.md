# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Python integration library for TeamSnap API v3 featuring OAuth 2.0 authentication (out-of-band flow), comprehensive data access, and automated API change monitoring. Built with modern Python tooling (`uv`) for fast dependency management.

## Essential Commands

### Setup & Installation
```bash
# Install dependencies (creates .venv automatically)
uv sync

# Install with dev dependencies
uv sync --all-extras
```

### Running Scripts
```bash
# All scripts should be run with uv
uv run python <script>.py

# Example: Run authentication
uv run python teamsnap_auth.py

# Example: Fetch all data
uv run python example.py
uv run python view_all_data.py

# Monitor API for changes
uv run python monitor_api.py
uv run python monitor_api.py --compare
uv run python monitor_api.py --show-deprecations
```

### Testing
```bash
# Run all tests
uv run pytest tests/ -v

# Run specific test file
uv run pytest tests/test_imports.py -v

# Run single test
uv run pytest tests/test_imports.py::test_client_has_methods -v
```

### Dependency Management
```bash
# Update all dependencies
uv sync --upgrade

# Add new dependency
uv add package-name

# Add dev dependency
uv add --dev package-name
```

## Architecture

### Core Components

**1. Authentication (`teamsnap_auth.py`)**
- Handles OAuth 2.0 out-of-band (OOB) flow
- TeamSnap requires `urn:ietf:wg:oauth:2.0:oob` as redirect URI (not localhost)
- Opens browser for auth, user manually copies code
- Tokens saved to `config.ini` and auto-managed (expiration tracking)

**2. API Client (`teamsnap_client.py`)**
- Base URL: `https://api.teamsnap.com/v3`
- Uses requests.Session with Bearer token authentication
- **Built-in Monitoring**: Automatically tracks API version and logs deprecation warnings
- Collection+JSON format responses (hypermedia/HATEOAS design)
- All convenience methods return parsed Collection+JSON items

**3. API Monitoring System (`monitor_api.py`)**
- Detects API changes (version, endpoints, deprecations)
- Saves snapshots to `api_snapshots/` directory
- Compare current state with previous snapshots
- TeamSnap doesn't publish changelogs - this is proactive monitoring

**4. Data Access Scripts**
- `example.py` - Basic demo showing user, teams, members, events
- `view_all_data.py` - Comprehensive data viewer for all endpoints
- `explore_api.py` - API endpoint discovery tool

### Key Design Patterns

**Collection+JSON Response Structure**:
```python
# TeamSnap API responses use Collection+JSON format
response = {
    'collection': {
        'version': '3.867.0',
        'items': [
            {
                'data': [
                    {'name': 'id', 'value': 123},
                    {'name': 'first_name', 'value': 'John'}
                ]
            }
        ],
        'links': [...],  # Related resources
        'queries': [...],  # Search endpoints
        'commands': [...]  # Action endpoints
    }
}

# Extract data using helper pattern:
def extract_data(item):
    data_array = item.get('data', [])
    result = {}
    for field in data_array:
        name = field.get('name')
        value = field.get('value')
        if name:
            result[name] = value
    return result
```

**API Version Tracking**:
- Client automatically checks version on init via `_check_api_version()`
- Logs warning if version changes
- Accessible via `client.get_api_version()`

**Deprecation Monitoring**:
- `monitor_deprecations=True` by default in client constructor
- Every GET request checks for `deprecated: true` flags in links
- Logs warnings automatically via `_check_deprecations()`
- Manual check via `client.check_for_deprecations(endpoint)`

### Configuration Management

**config.ini Structure**:
```ini
[teamsnap]
client_id = <from TeamSnap OAuth app>
client_secret = <from TeamSnap OAuth app>
redirect_uri = urn:ietf:wg:oauth:2.0:oob  # Must be this exact value
access_token = <auto-generated>
refresh_token = <auto-generated>
token_expires_at = <auto-generated ISO timestamp>
```

**Important**:
- `config.ini` is gitignored (contains secrets)
- Use `config.ini.template` as reference
- TeamSnap OAuth app managed at: https://auth.teamsnap.com/oauth/applications

## TeamSnap API Specifics

### Authentication Flow
1. User must set redirect URI to `urn:ietf:wg:oauth:2.0:oob` in TeamSnap OAuth app
2. Script opens browser to `https://auth.teamsnap.com/oauth/authorize`
3. User approves, TeamSnap displays code in browser
4. User copies code, pastes into terminal
5. Script exchanges code for token at `https://auth.teamsnap.com/oauth/token`
6. Token saved to `config.ini` for reuse

### API Quirks
- **No Public Changelog**: TeamSnap doesn't publish API changes - requires proactive monitoring
- **Hypermedia Design**: Endpoints discovered through links, not hardcoded
- **Deprecation In-Response**: Deprecation warnings embedded in API responses (not separate docs)
- **Collection+JSON**: All responses use this format (not plain JSON)
- **Version in URL + Response**: Major version in path (`/v3/`), minor in response (`3.867.0`)

### Available Endpoints (via client convenience methods)
- `get_me()`, `get_user(user_id)`
- `search_teams(user_id)`, `get_team(team_id)`
- `search_members(team_id)`
- `search_events(team_id)`, `get_event(event_id)`
- `search_forum_topics(team_id)`, `search_forum_posts(team_id, topic_id)`
- `search_broadcast_emails(team_id)`
- `search_messages(team_id)`
- `search_assignments(team_id, event_id)`
- `search_opponents(team_id)`, `search_locations(team_id)`
- `custom_request(method, endpoint, **kwargs)` - for any endpoint

## Automated Workflows

### GitHub Actions (runs automatically)
- **CI** (`.github/workflows/ci.yml`): Tests on Python 3.8-3.12, runs on every push/PR
- **Dependency Updates** (`.github/workflows/update-dependencies.yml`): Weekly Monday 9am UTC
- **API Monitoring** (`.github/workflows/monitor-api.yml`): Weekly Monday 10am UTC, creates issues if changes detected
- **Dependabot** (`.github/dependabot.yml`): Weekly dependency PR creation

### API Snapshots
- Stored in `api_snapshots/` directory
- `latest.json` = most recent state
- `snapshot_YYYYMMDD_HHMMSS.json` = timestamped history
- Committed to repo (track API evolution)
- Compare with: `uv run python monitor_api.py --compare`

## Development Workflow

### Adding New Endpoints
1. Discover endpoint via `uv run python explore_api.py`
2. Add method to `TeamSnapClient` class in `teamsnap_client.py`
3. Follow pattern of existing methods (use `self.get()`, return items from collection)
4. Add test to `tests/test_imports.py` (check method exists)
5. Document in method docstring

### Testing OAuth Changes
- Don't commit `config.ini` (contains secrets)
- Test with: `uv run python teamsnap_auth.py`
- Browser must be open and user logged into TeamSnap
- Requires actual TeamSnap account

### When API Changes Detected
1. GitHub Actions creates issue automatically (weekly check)
2. Review changes in monitoring output
3. Test integration: `uv run python example.py`
4. Update client methods if endpoints changed
5. Update tests if needed
6. Close issue when resolved

## Important Files

- **teamsnap_client.py**: Main API client (add new methods here)
- **teamsnap_auth.py**: OAuth flow (rarely needs changes)
- **monitor_api.py**: API monitoring (extend for new checks)
- **config.ini**: User's credentials (NEVER commit)
- **MAINTENANCE.md**: Comprehensive maintenance procedures
- **api_snapshots/**: Historical API state records

## Common Patterns

### Error Handling in API Calls
```python
try:
    response = client.search_teams(user_id=123)
    # Handle response
except requests.exceptions.HTTPError as e:
    # Client logs error details automatically
    # Handle or re-raise
```

### Parsing Collection+JSON
```python
# Always check for collection â†’ items structure
response = client.get('/endpoint')
items = response.get('collection', {}).get('items', [])

for item in items:
    data = item.get('data', [])
    # Build dict from name/value pairs
    parsed = {field['name']: field['value'] for field in data if 'name' in field}
```

### Enabling Logging
```python
import logging
logging.basicConfig(level=logging.INFO)  # See version checks
logging.basicConfig(level=logging.WARNING)  # See deprecations only

from teamsnap_client import TeamSnapClient
client = TeamSnapClient()  # Will log version and deprecations
```

## Notes for Future Development

- Python 3.8+ required (consider bumping to 3.9+ when 3.8 reaches EOL)
- Uses `uv` (not pip) - much faster, auto-manages venv
- All OAuth must use OOB flow (TeamSnap doesn't allow localhost URLs)
- API monitoring is critical since TeamSnap provides no changelog
- Collection+JSON parsing is consistent across all endpoints
- Client auto-authenticates by default (can disable with `auto_authenticate=False`)
