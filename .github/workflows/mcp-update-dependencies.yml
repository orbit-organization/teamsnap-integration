name: MCP Server - Update Dependencies

on:
  schedule:
    # Run every Monday at 9:30am UTC (30 min after main integration)
    - cron: '30 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Set up Python
        run: uv python install

      - name: Update dependencies
        working-directory: teamsnap_mcp
        run: |
          # Capture current state
          echo "ðŸ“‹ Current MCP dependencies:" > /tmp/mcp-deps-before.txt
          uv pip list >> /tmp/mcp-deps-before.txt 2>&1 || echo "No previous dependencies"

          echo "ðŸ“¦ Updating MCP server dependencies..."
          uv sync --upgrade
          echo "âœ… Dependencies updated"

          # Capture new state
          echo "ðŸ“‹ Updated MCP dependencies:" > /tmp/mcp-deps-after.txt
          uv pip list >> /tmp/mcp-deps-after.txt 2>&1

      - name: Analyze dependency changes
        id: analyze
        run: |
          if git diff --quiet teamsnap_mcp/uv.lock; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No dependency changes detected"
            exit 0
          fi

          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Dependency changes detected"

          # Generate detailed PR body
          cat > /tmp/mcp-pr-body.md << 'EOFMARKER'
          ## Automated Dependency Update - MCP Server

          This PR updates all dependencies for the TeamSnap MCP server to their latest compatible versions.

          ### Updated Packages

          EOFMARKER

          # Add version diff
          if [ -f /tmp/mcp-deps-before.txt ] && [ -f /tmp/mcp-deps-after.txt ]; then
            echo '```diff' >> /tmp/mcp-pr-body.md
            diff /tmp/mcp-deps-before.txt /tmp/mcp-deps-after.txt | grep -E '^[<>]' | head -30 || echo "No version changes in pip list output"
            echo '```' >> /tmp/mcp-pr-body.md
          fi

          cat >> /tmp/mcp-pr-body.md << 'EOFMARKER'

          ### Files Changed
          - `teamsnap_mcp/uv.lock` - MCP server dependency lock file

          ### Impact Assessment
          - âœ… All automated tests passed
          - ðŸ” **Review for breaking changes**: Check if any packages have major version bumps
          - âš ï¸ **MCP Protocol**: Verify `mcp` package changes don't break tool definitions
          - ðŸ”Œ **httpx/FastMCP**: These are critical - test thoroughly if updated

          ### Critical Dependencies to Watch
          - `mcp` - Model Context Protocol SDK
          - `httpx` - Async HTTP client (used for TeamSnap API)
          - `python-dotenv` - Environment variable management

          Major version changes in these require extra testing!

          ### Testing Checklist
          - [ ] Pull this branch
          - [ ] Run `cd teamsnap_mcp && uv sync`
          - [ ] Verify imports: `uv run python -c "from server import mcp; from client import TeamSnapAsyncClient"`
          - [ ] Run tests: `export TEAMSNAP_ACCESS_TOKEN=test && uv run pytest tests/ -v`
          - [ ] **Test in Claude Desktop**:
            1. Update config to point to this branch
            2. Restart Claude Desktop
            3. Try: "List my TeamSnap teams"
            4. Try creating/updating data (if readonly mode disabled)
          - [ ] Check no errors in Claude Desktop logs

          ### Merge Safety
          - âœ… Safe to merge if tests pass and no major version bumps
          - âš ï¸ Test in Claude Desktop before merging if major versions changed
          - ðŸš¨ Do NOT merge if `mcp` package has breaking changes without testing

          ---
          ðŸ¤– This PR was created automatically by GitHub Actions
          EOFMARKER

      - name: Run tests
        if: steps.analyze.outputs.changes == 'true'
        working-directory: teamsnap_mcp
        env:
          TEAMSNAP_ACCESS_TOKEN: test_token_for_ci
        run: |
          uv run pytest tests/ -v

      - name: Create Pull Request
        if: steps.analyze.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update MCP server dependencies

            Automated weekly dependency update for TeamSnap MCP server.

            ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>
          branch: mcp-update-dependencies
          delete-branch: true
          title: 'ðŸ”„ Update MCP Server Dependencies'
          body-path: /tmp/mcp-pr-body.md
          labels: dependencies, mcp-server, automated

      - name: Output result
        if: steps.analyze.outputs.changes == 'false'
        run: |
          echo "âœ¨ All MCP server dependencies are up to date!"
